# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1

orbs:
    docker: circleci/docker@2.1.1

docker:
  - image: docker:17.05.0-ce-git

services:
  - docker

# Define a job to be invoked later in a workflow. See: https://circleci.com/docs/2.0/configuration-reference/#jobs
jobs:
  mobsf:
    # Specify the execution environment. You can specify an image from Dockerhub or use one of our Convenience Images from CircleCI's Developer Hub. 
    # See: https://circleci.com/docs/2.0/configuration-reference/#docker-machine-macos-windows-executor
    docker:
      - image: opensecurity/mobile-security-framework-mobsf
    # Add steps to the job. See: https://circleci.com/docs/2.0/configuration-reference/#steps
    steps:
    #  - checkout
      - run:
          name: "working?"
          command: #"echo Works up to this point"
            docker info
            #docker pull opensecurity/mobile-security-framework-mobsf  
      - run:
          name: "Create env var file"
          command: echo "MOBSF_API_KEY=$MOBSF_API_KEY" > env.list 
      - run:
          name: "Run MobSF"
          command: docker run -it --env-file ./env.list -p 8000:8000 opensecurity/mobile-security-framework-mobsf:latest 
      - run:
          name: "Upload to MobSF"
          command: response=`curl -F 'file=@./my-build.apk' http://localhost:8000/api/v1/upload -H "Authorization:$MOBSF_API_KEY"`
                   SCAN_TYPE=`echo $response | jq '.scan_type' | sed 's/"//g'`
                   FILE_NAME=`echo $response | jq '.file_name' | sed 's/"//g'`
                   HASH=`echo $response | jq '.hash' | sed 's/"//g'`
                   echo "export SCAN_TYPE=$SCAN_TYPE" >> $BASH_ENV
                   echo "export FILE_NAME=$FILE_NAME" >> $BASH_ENV
                   echo "export HASH=$HASH" >> $BASH_ENV
      - run:
          name: "Scan"
          command: response=`curl -X POST --url http://localhost:8000/api/v1/scan --data "scan_type=$SCAN_TYPE&file_name=$FILE_NAME&hash=$HASH" -H "Authorization:$MOBSF_API_KEY"`
                   echo $response >> report.json 
      - run:
          name: "Parse with OWASP glue"
          command: docker run -it -v $(pwd):/app owasp/glue:raw-latest ruby bin/glue -t Dynamic -T /app/report.json --mapping-file mobsf --finding-file-path /app/android.json

# Invoke jobs via workflows. See: https://circleci.com/docs/2.0/configuration-reference/#workflows
workflows:
  mobsf-workflow:
    jobs:
      - mobsf
      
      

